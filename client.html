<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WebSocket Room Example</title>
<style>
body { 
    font-family: Arial, sans-serif; 
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

.screen {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    padding: 40px;
    text-align: center;
    min-width: 400px;
    display: none;
}

.screen.active { display: block; }

h1 { 
    color: #333; 
    margin-bottom: 30px;
    font-size: 28px;
}

h2 { 
    color: #555; 
    margin-bottom: 20px;
}

.avatar-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.avatar-option {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid #ddd;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    transition: all 0.3s ease;
    margin: 0 auto;
}

.avatar-option:hover {
    transform: scale(1.1);
    border-color: #667eea;
}

.avatar-option.selected {
    border-color: #667eea;
    box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
}

.name-input {
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    margin: 20px 0;
    width: 100%;
    box-sizing: border-box;
}

.name-input:focus {
    outline: none;
    border-color: #667eea;
}

.btn {
    background: #667eea;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    margin: 10px;
    transition: background 0.3s ease;
}

.btn:hover {
    background: #5a6fd8;
}

.btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.btn.secondary {
    background: #95a5a6;
}

.btn.secondary:hover {
    background: #7f8c8d;
}

.room-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin: 20px 0;
}

.room-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.room-item:hover {
    background: #f8f9fa;
}

.room-item:last-child {
    border-bottom: none;
}

.room-name {
    font-weight: bold;
    color: #333;
}

.room-players {
    color: #666;
    font-size: 14px;
}

.create-room-form {
    margin: 20px 0;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #f8f9fa;
}

.emoji-flash {
    animation: flash 1s ease-in-out;
}
@keyframes flash {
    0% { opacity: 0; transform: scale(0.5); }
    50% { opacity: 1; transform: scale(1.2); }
    100% { opacity: 0; transform: scale(1); }
}

#room {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    padding: 20px;
    min-width: 600px;
}

#players {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

#messages {
    border: 1px solid #ddd;
    border-radius: 8px;
    height: 200px;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 10px;
    background: #f9f9f9;
}

#chatInput {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    width: calc(100% - 100px);
    margin-right: 10px;
}

#emojiWheel {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 10;
}

.emojiOption {
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.emojiOption:hover {
    background: #f0f0f0;
}
</style>
</head>
<body>

<!-- Avatar Selection Screen -->
<div id="avatarScreen" class="screen active">
    <h1>Choose Your Avatar</h1>
    <div class="avatar-grid">
        <div class="avatar-option" data-avatar="üòÄ">üòÄ</div>
        <div class="avatar-option" data-avatar="üòé">üòé</div>
        <div class="avatar-option" data-avatar="ü§ñ">ü§ñ</div>
        <div class="avatar-option" data-avatar="üê±">üê±</div>
        <div class="avatar-option" data-avatar="ü¶Ñ">ü¶Ñ</div>
        <div class="avatar-option" data-avatar="üéÆ">üéÆ</div>
        <div class="avatar-option" data-avatar="‚ö°">‚ö°</div>
        <div class="avatar-option" data-avatar="üî•">üî•</div>
    </div>
    <input type="text" id="playerName" class="name-input" placeholder="Enter your name" maxlength="20">
    <br>
    <button class="btn" onclick="goToRoomSelect()" id="nextBtn" disabled>Next</button>
</div>

<!-- Room Selection Screen -->
<div id="roomScreen" class="screen">
    <h1>Join or Create Room</h1>
    
    <h2>Active Rooms</h2>
    <div id="roomList" class="room-list">
        <div style="padding: 20px; color: #666;">Loading rooms...</div>
    </div>
    
    <div class="create-room-form">
        <h2>Create New Room</h2>
        <input type="text" id="newRoomName" class="name-input" placeholder="Room name" maxlength="30">
        <br>
        <button class="btn" onclick="createRoom()">Create Room</button>
    </div>
    
    <button class="btn secondary" onclick="goBackToAvatar()">Back</button>
</div>

<!-- Game Room -->
<div id="room">
    <h2 id="roomTitle"></h2>
    <div id="players"></div>
    <div id="messages"></div>
    <input id="chatInput" placeholder="Type message...">
    <button class="btn" onclick="sendChat()">Send</button>
    <div id="emojiWheel">
        <span class="emojiOption">üòÄ</span>
        <span class="emojiOption">üòé</span>
        <span class="emojiOption">ü§ñ</span>
    </div>
</div>

<script>
let ws;
let myName = "";
let myAvatar = "";
let myRoom = "";
let playersState = [];

// Avatar selection
document.querySelectorAll('.avatar-option').forEach(option => {
    option.onclick = function() {
        document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        myAvatar = this.dataset.avatar;
        checkNextButton();
    };
});

document.getElementById('playerName').oninput = checkNextButton;

function checkNextButton() {
    const nameValid = document.getElementById('playerName').value.trim().length > 0;
    const avatarSelected = myAvatar !== "";
    document.getElementById('nextBtn').disabled = !(nameValid && avatarSelected);
}

function goToRoomSelect() {
    myName = document.getElementById('playerName').value.trim();
    document.getElementById('avatarScreen').classList.remove('active');
    document.getElementById('roomScreen').classList.add('active');
    loadRooms();
}

function goBackToAvatar() {
    document.getElementById('roomScreen').classList.remove('active');
    document.getElementById('avatarScreen').classList.add('active');
}

function loadRooms() {
    // Connect to get room list
    if (ws) ws.close();
    ws = new WebSocket("ws://localhost:8080");
    ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'getRooms' }));
    };
    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'roomList') {
            displayRooms(msg.rooms);
        }
        if (msg.type === 'system') {
            if (msg.message.includes('joined')) {
                // Successfully joined room
                document.getElementById('roomScreen').style.display = 'none';
                document.getElementById('room').style.display = 'block';
                document.getElementById('roomTitle').innerText = `Room: ${myRoom}`;
            }
            if (msg.players) {
                playersState = msg.players.map(p => ({ 
                    name: p.name || p, 
                    avatar: p.avatar || 'üòÄ' 
                }));
                renderPlayers();
            }
        }
        if (msg.type === 'chat') {
            addMessage(`${msg.from}: ${msg.message}`);
        }
        if (msg.type === 'emojiFlash') {
            flashEmojiOnPlayer(msg.playerName, msg.emoji);
        }
    };
}

function displayRooms(rooms) {
    const roomList = document.getElementById('roomList');
    if (rooms.length === 0) {
        roomList.innerHTML = '<div style="padding: 20px; color: #666;">No active rooms</div>';
        return;
    }
    
    roomList.innerHTML = '';
    rooms.forEach(room => {
        const roomItem = document.createElement('div');
        roomItem.className = 'room-item';
        roomItem.onclick = () => joinRoom(room.id);
        
        roomItem.innerHTML = `
            <div>
                <div class="room-name">${room.name}</div>
                <div class="room-players">${room.playerCount} players</div>
            </div>
            <div>Join ‚Üí</div>
        `;
        roomList.appendChild(roomItem);
    });
}

function createRoom() {
    const roomName = document.getElementById('newRoomName').value.trim();
    if (!roomName) return alert('Enter a room name');
    
    const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
    joinRoom(roomId, roomName);
}

function joinRoom(roomId, roomName = null) {
    myRoom = roomId;
    ws.send(JSON.stringify({ 
        type: 'join', 
        playerName: myName, 
        playerAvatar: myAvatar,
        roomId: roomId,
        roomName: roomName
    }));
}

function sendChat() {
    const input = document.getElementById("chatInput");
    if (input.value.trim()) {
        ws.send(JSON.stringify({ type: 'chat', message: input.value }));
    }
    input.value = '';
}

function renderPlayers() {
    const playersDiv = document.getElementById("players");
    playersDiv.innerHTML = '';
    playersState.forEach(player => {
        const iconDiv = document.createElement('div');
        iconDiv.style.display = 'flex';
        iconDiv.style.flexDirection = 'column';
        iconDiv.style.alignItems = 'center';
        iconDiv.style.position = 'relative';
        iconDiv.style.width = '60px';
        iconDiv.style.cursor = player.name === myName ? 'pointer' : 'default';
        iconDiv.dataset.playerName = player.name;
        
        // Icon circle
        const circle = document.createElement('div');
        circle.style.width = '48px';
        circle.style.height = '48px';
        circle.style.borderRadius = '50%';
        circle.style.background = '#eee';
        circle.style.display = 'flex';
        circle.style.alignItems = 'center';
        circle.style.justifyContent = 'center';
        circle.style.fontSize = '24px';
        circle.style.position = 'relative';
        circle.innerText = player.avatar || player.name[0].toUpperCase();
        iconDiv.appendChild(circle);
        
        // Name
        const nameDiv = document.createElement('div');
        nameDiv.innerText = player.name;
        nameDiv.style.fontSize = '12px';
        iconDiv.appendChild(nameDiv);
        
        // Click to select emoji (only for self)
        if (player.name === myName) {
            iconDiv.onclick = (e) => {
                showEmojiWheel(e, iconDiv);
            };
        }
        playersDiv.appendChild(iconDiv);
    });
}

function flashEmojiOnPlayer(playerName, emoji) {
    const playerDiv = document.querySelector(`[data-player-name="${playerName}"]`);
    if (!playerDiv) return;
    
    const circle = playerDiv.querySelector('div');
    const emojiSpan = document.createElement('span');
    emojiSpan.innerText = emoji;
    emojiSpan.style.position = 'absolute';
    emojiSpan.style.right = '-8px';
    emojiSpan.style.bottom = '-8px';
    emojiSpan.style.fontSize = '22px';
    emojiSpan.classList.add('emoji-flash');
    circle.appendChild(emojiSpan);
    
    setTimeout(() => {
        if (emojiSpan.parentNode) {
            emojiSpan.parentNode.removeChild(emojiSpan);
        }
    }, 1000);
}

function showEmojiWheel(event, anchorDiv) {
    const wheel = document.getElementById('emojiWheel');
    wheel.style.display = 'block';
    const rect = anchorDiv.getBoundingClientRect();
    wheel.style.left = (rect.left + window.scrollX) + 'px';
    wheel.style.top = (rect.bottom + window.scrollY + 5) + 'px';
}

// Hide emoji wheel on click elsewhere
document.addEventListener('click', function(e) {
    const wheel = document.getElementById('emojiWheel');
    if (!wheel.contains(e.target) && !e.target.closest('#players')) {
        wheel.style.display = 'none';
    }
});

// Handle emoji selection
document.querySelectorAll('.emojiOption').forEach(el => {
    el.onclick = function() {
        const emoji = this.innerText;
        ws.send(JSON.stringify({ type: 'emoji', emoji }));
        document.getElementById('emojiWheel').style.display = 'none';
    };
});

function addMessage(text) {
    const messages = document.getElementById("messages");
    messages.innerHTML += text + "<br>";
    messages.scrollTop = messages.scrollHeight;
}
</script>

</body>
</html>
